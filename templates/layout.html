<!doctype html>
<html lang="en">
<head>
    <base target="_self">   <!-- â˜… FIX: Forces all links to open in the same tab -->
    <meta charset="UTF-8">
    <title>To Promote a Sustainable World</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        a { color: #90ee90; text-decoration: none; }
        a:hover { color: #aaffaa; text-decoration: none; }
        .navbar, .btn-light, .btn-outline-light { background-color: #1e1e1e !important; color: #f0f0f0 !important; }
        .navbar-brand { font-weight: bold; font-size: 1.6rem; }
        .btn { border-radius: 8px; }
        .card { background-color: #1f1f1f; border: none; border-radius: 12px; transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .card-title, .card-text { color: #f0f0f0; }
        .form-control, textarea { background-color: #1e1e1e; color: #f0f0f0; border: 1px solid #333; }
        .form-control:focus, textarea:focus { border: 1px solid #90ee90; box-shadow: none; }
        .btn-success { background-color: #4CAF50; border: none; }
        .btn-success:hover { background-color: #66bb6a; }
        .btn-warning { background-color: #f0ad4e; border: none; }
        .btn-warning:hover { background-color: #f7b16b; }
        .btn-info { background-color: #17a2b8; border: none; }
        .btn-info:hover { background-color: #38c3d0; }

        .notification-bell { position: relative; cursor: pointer; }
        .notification-bell svg { color: #f0f0f0; transition: color 0.2s; }
        .notification-bell.has-unread svg { color: #00ff00; }
        .notification-count { position: absolute; top: -5px; right: -5px; background-color: #ff4d4d; color: white; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 50%; }

        footer { text-align: center; padding: 15px; margin-top: 40px; font-size: 0.9rem; color: #aaa; }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark mb-4 px-4">
    <a class="navbar-brand" href="/">To Promote a Sustainable World ðŸŒŽ</a>

    <div class="ms-auto d-flex align-items-center">
        {% if session.get('username') %}
            <span class="me-3">Hello, {{ session['username'] }}</span>

            <div class="dropdown me-3">
                <div class="notification-bell {% if unread_count > 0 %}has-unread{% endif %}" id="notifDropdown" data-bs-toggle="dropdown">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16">
                        <path d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.104-14.3c.545 0 1.054.43 1.187 1.004A7.001 7.001 0 0 1 15 9c0 1.098.5 2.077 1.2 2.764-.427-.87-.2-1.874-.106-2.39C15.002 8.326 14.902 8 14 8h-4.105A2.992 2.992 0 0 0 8 2.7z"/>
                    </svg>

                    {% if unread_count > 0 %}
                        <span class="notification-count" id="notifCount">{{ unread_count }}</span>
                    {% else %}
                        <span class="notification-count d-none" id="notifCount">0</span>
                    {% endif %}
                </div>

                <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notifDropdown" id="notifMenu">
                    {% for notif in latest_notifications %}
                        <li class="dropdown-item">{{ notif['message'] }}<br><small class="text-muted">{{ notif['timestamp'] | datetimeformat }}</small></li>
                    {% else %}
                        <li class="dropdown-item">No notifications</li>
                    {% endfor %}
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-center" href="/notifications">See all notifications</a></li>
                </ul>
            </div>

            <a href="/logout" class="btn btn-warning btn-sm me-2">Logout</a>
            <a href="/post" class="btn btn-success btn-sm">Post Item</a>
        {% else %}
            <a href="/login" class="btn btn-light btn-sm me-2">Login</a>
            <a href="/register" class="btn btn-success btn-sm">Register</a>
        {% endif %}
    </div>
</nav>

<div class="container">{% block content %}{% endblock %}</div>

<footer>
    To Promote a Sustainable World ðŸŒŽ â€” Reduce, Reuse, Recycle
</footer>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    const socket = io();
    const CURRENT_USER = "{{ session.get('username') or '' }}";

    socket.on("new_notification", data => {
        if (!CURRENT_USER || data.user !== CURRENT_USER) return;

        const bell = document.querySelector(".notification-bell");
        bell.classList.add("has-unread");

        const countBox = document.getElementById("notifCount");
        let count = parseInt(countBox.innerText) || 0;
        count += 1;
        countBox.innerText = count;
        countBox.classList.remove("d-none");

        const menu = document.getElementById("notifMenu");
        const li = document.createElement("li");
        li.className = "dropdown-item";
        li.innerHTML = `${data.message}<br><small class="text-muted">${data.time}</small>`;
        menu.insertBefore(li, menu.firstChild);
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
